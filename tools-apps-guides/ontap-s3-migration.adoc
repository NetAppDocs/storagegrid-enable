---
permalink: tools-apps-guides/ontap-s3-migration.html
sidebar: sidebar
keywords: S3, ONTAP S3, ONTAP, StorageGRID, migration
summary: Migrate from ONTAP S3 to StorageGRID. 
---
= Enabling enterprise-grade S3 by seamlessly migrating object-based storage from ONTAP S3 to StorageGRID
:hardbreaks:
:icons: font
:imagesdir: ../media/

[.lead]
Enabling enterprise-grade S3 by seamlessly migrating object-based storage from ONTAP S3 to StorageGRID

== Migration Demo

=== Preparing ONTAP

For demonstration purposes we will create an SVM object store server, user, group, group policy and buckets.

==== Create the Storage Virtual Machine

In ONTAP System Manager, navigate to Storage VM's and add a new storage VM.

image:ontap-migrate/ontap-svm-add-01.png[Add a new SVM]

Select the "Enable S3" and "Enable TLS" check boxes and configure the HTTP(S) ports. Define the IP, subnet mask and define the gateway and broadcast domain if not using the default or required in your environment.

image:ontap-migrate/ontap-svm-create-01.png[configure new SVM]

As part of the SVM creation a user will be created. download the S3 keys for this user and close the window.

image:ontap-migrate/ontap-s3-key.png[download S3 keys]

Once the SVM has created, edit the SVM and add the DNS settings.

image:ontap-migrate/ontap-dns-01.png[configure DNS]

Define the DNS name and IP

image:ontap-migrate/ontap-dns-02.png[configure DNS Server]

==== Create SVM S3 User

Now we can configure the S3 users and group. Edit the S3 settings

image:ontap-migrate/ontap-edit-s3.png[Configure S3]

Add a new user

image:ontap-migrate/ontap-user-create-01.png[Add a new user]

Input the user name and key expiration

image:ontap-migrate/ontap-user-create-01.png[Add a new user]

Download the S3 keys for the new user.

image:ontap-migrate/ontap-user-keys.png[new user s3 keys]

==== Create SVM S3 group

On the Groups tab of the SVM S3 settings, add a new group with the user created above and FullAccess permissions.

image:ontap-migrate/ontap-add-group.png[Add S3 group]

==== Create SVM S3 buckets

Navigate to the Buckets section and click the "+Add" button.

image:ontap-migrate/ontap-add-bucket-01.png[Add Bucket]

Enter a name, capacity, and deselect the "Enable ListBucket access..." check box. and click on the "More options" button.

image:ontap-migrate/ontap-add-bucket-02.png[Add Bucket]

In the "More options" section seletect the enable versioning check box. and click the "Save" button.

image: ontap-migrate/ontap-add-bucket-ver-01.png[Enable versioning]

Repeat the process and create a second bucket without versioning enabled. Enter a name, the same capacity as bucket one, and deselect the "Enable ListBucket access..." check box. and click on the "Save" button.

image:ontap-migrate/ontap-add-bucket2-01.png[Add bucket two]

=== Preparing StorageGRID

Continuing the configuration for this demo we will create a Tenant, user, security group, group policy, and bucket.

==== Create the tenant

Navigate to the "Tenants" tab and click on the "create" button

image:ontap-migrate/sg-tenant-create-01.png[Add tenant button]

Fill in the details for the tenant providing a tenant name, select S3 for the client type, and no quota is required. no need to select platform services or allow S3 select. You can choose to use own Identity source if you choose. Set the root password and click on the finish button.

Click on the tenant name to view the tenant details.  *You will need the tenant ID later so copy it off*.
Click on the Sign in button. This will bring you to the tenant portal login.  Save the URL for future use.

image:ontap-migrate/sg-tenant-select.png[Select the Tenant]

This will bring you to the tenant portal login.  Save the URL for future use, and enter the root user credentials.

image:ontap-migrate/sg-tenant-login.png[Tenant login]

==== Create the user

Navigate to the Users tab and create a new user.

image:ontap-migrate/sg-user-create-01.png[Navigate to users]

image:ontap-migrate/sg-user-create-02.png[Create new user]

Now that the new user has been created, click on the users name to open the details of the user.

Copy the user ID from the URL to be used later.

image:ontap-migrate/sg-user-id.png[Copy new ID]

To create the S3 keys click on the user name.

image:ontap-migrate/sg-user-keys-create-01.png[Create S3 Keys]

select the "Access keys" tab and click on the "Create Key" button. There is no need to set an expiration time. Download the S3 keys as they cannot be retrieved again once the window is closed.

image:ontap-migrate/sg-user-keys-create-02.png[Download keys]

==== Create the security group

Now go to the Groups page and create a new group.

image:ontap-migrate/sg-group-create.png[Create new group]

Set the group permissions to Read-Only. This is the Tenant UI permissions, not the S3 permissions.

image:ontap-migrate/sg-group-permissions.png[Set group Permissions]

S3 permissions are controlled with the group policy (IAM Policy). Set the Group policy to custom and paste the json policy in the box.

[source,json]
----
{
    "Statement": [
      {
        "Effect": "Allow",
        "Action": "s3:ListAllMyBuckets",
        "Resource": "arn:aws:s3:::*"
      },
      {
         "Effect": "Allow",
        "Action": "s3:ListAllMyBuckets",
        "Resource": ["arn:aws:s3:::bucket","arn:aws:s3:::bucket/*"]
      }
    ]
}
----

image:ontap-migrate/sg-group-policy.png[Define group policy]

finally, add the user to the group and finish.

image:ontap-migrate/sg-group-add-user.png[Add user to group]

==== Create two buckets

Navigate to the buckets tab and click on the Create bucket button.

image:ontap-migrate/sg-create-buckets.png[Create Buckets page]

Define the bucket name and region.

image:ontap-migrate/sg-create-bucket1-01.png[Create Buckets page]

On this first bucket enable versioning.

image:ontap-migrate/sg-bucket1-vers.png[Set versioning]

Now create a second bucket without versioning enabled.

image:ontap-migrate/sg-create-bucket2.png[Create Second bucket]

Do not enable versioning on this second bucket.

image:ontap-migrate/sg-create-bucket2-nver.png[do not set versioning]


=== Populate the Source Bucket

Lets put some objects in the source ONTAP bucket. We will use S3Browser for this demo but you could use any tool you are comfortable with.

Using the ONTAP user s3 keys created above, configure S3Browser to connect to your ontap system.

image:ontap-migrate/ontap-s3browser-conf.png[S3Browser-config]

Now lets upload some files to the versioning enabled bucket. 

image:ontap-migrate/ontap-s3browser-upload-01.png[Click on upload]

image:ontap-migrate/ontap-s3browser-upload-02.png[Select files to upload]

image:ontap-migrate/ontap-s3browser-upload-03.png[Files uploaded]

Now lets create some object versions in the bucket.

delete a file.

image:ontap-migrate/ontap-s3browser-delete.png[Delete a file]

Upload a file that already exists in the bucket to copy the file over itself and create a new version of it. 

image:ontap-migrate/ontap-s3browser-overwrite.png[upload a file that already exists]

In S3Browser we can view the versions of the objects we just created.

image:ontap-migrate/ontap-s3browser-versions.png[View versions]

=== Establish the replication relationship

Lets start sending data from ONTAP to StorageGRID.

In ONTAP System Manager navigate to "Protection/Overview". Scroll down to "Cloud object stores". and click the "Add" button and select "StorageGRID".

image:ontap-migrate/ontap-protection-add-01.png[ONTAP Protection]

Input the StorageGRID information by providing a name, URL style (for this demo we will use Path-styl URLs). Set the object store scope to "Storage VM".

image:ontap-migrate/ontap-protection-configure-01.png[Input StorageGRID information]

If you are using SSL, set the load balancer endpoint port and copy in the StorageGRID endpoint certificate here. otherwise uncheck the SSL box and input the HTTP endpoint port here.

Input the StorageGRID user S3 keys and bucket name from the StorageGRID configuration above for the destination.

image:ontap-migrate/ontap-protection-configure-02.png[Input StorageGRID information]

Now that we have a destination target configured, we can configure the policy settings for the target.  Expand "Local policy settings" and select "continuous".

image:ontap-migrate/ontap-local-setting.png[Local policy settings]

Edit the continuous policy and change the "Recovery point objective" from "1 Hours" to "3 Seconds".

image:ontap-migrate/ontap-local-edit.png[Local policy settings edit]

Now we can configure snapmirror to replicate the bucket. 

[source]
====
snapmirror create -source-path sv_demo: /bucket/bucket -destination-path sgws_demo: /objstore -policy Continuous
====

image:ontap-migrate/ontap-snapmirror-create.png[Create snapmirror relationship]

The bucket will now show a cloud symbol in the bucket list under protection.

image:ontap-migrate/ontap-bucket-protected.png[The bucket is protected to the cloud target]

If we select the bucket and go to the "SnapMirror (ONTAP or Cloud)" tab we will see the snapmirror repationship status.

image:ontap-migrate/ontap-snapmirror-status.png[Check snapmirror relationship]

=== The replication details

We now have a successfully replicating bucket from ONTAP to StorageGRID. But what is actually replicating? Our source and destination are both versioned buckets. Do the previous versions also replicate to the destination? If we look at our StorageGRID bucket with S3Browser we see that the existing versions did not replicate and our deleted object does not exist, nor does a delete marker for that object. Our duplicated object only has 1 version in the StorageGRID bucket.

image:ontap-migrate/sg-s3browser-initial.png[S3browser view of the StorageGRID bucket after initial sync]

In our ONTAP bucket, lets add a new version to our same object that we used previously and see how it replicates.

image:ontap-migrate/ontap-s3browser-new-rep.png[S3browser view of the ONTAP bucket after new version uploaded]

If we look on the StorageGRID side we see that a new version has been created in this bucket too, but is missing the initial version from before the snapmirror relationship.

image:ontap-migrate/sg-s3browser-rep-ver.png[S3browser view of the ONTAP bucket after new version uploaded]

This is because the ONTAP SnapMirror S3 process only replicates the current version of the object. This is why we created a versioned bucket on the StorageGRID side to be the destination. This way StorageGRID can maintain a version history of the objects. 

=== Migrate S3 Keys

For a migration, most of the time you will want to migrate the credentials for the users rather than generate new credentials on the destination side. StorageGRID provides api's to allow s3 keys to be imported to a user.

Logging into the StorageGRID management UI (not the tenant manager UI) open the API Documentation swagger page.

image:ontap-migrate/sg-api-swagger.png[Open the API Documentation]

Expand the "accounts" section, select the "POST /grid/account-enable-s3-key-import", click the "Try it out" button, then click on the execute button.

image:ontap-migrate/sg-import-enable.png[Enable S3 key import]

now scroll down still under "accounts" to "POST /grid/accounts/{id}/users/{user_id}/s3-access-keys"

Here is where we are going to input the tenant ID and user account ID we collected earlier. fill in the fields and the keys from our ONTAP user in the json box. you can set the expiration of the keys, or remove the " , "expires": 123456789" and click on execute.

image:ontap-migrate/sg-import-key.png[import the S3 key]

Once you have completed all of your user key imports you should disable the key import function in "accounts" "POST /grid/account-disable-s3-key-import"

image:ontap-migrate/sg-import-disable.png[Disable S3 key import]

If we look at the user account in the tenant manager UI, we can see the new key has been added.

image:ontap-migrate/sg-user-keys.png[User keys]

=== The final cut-over

If the intention is to have a perpetually replicating bucket from ONTAP to StorageGRID, you can end here.  If this is a migration from ONTAP S3 to StorageGRID, then its time to put an end to it and cut over.

Inside ONTAP system manager, edit the S3 group and set it to "ReadOnlyAccess". This will prevent the users from writing to the ONTAP S3 bucket anymore.

image:ontap-migrate/ontap-edit-group.png[Set ONTAP group to read-only]

All that is left to do is configure DNS to point from the ONTAP cluster to the StorageGRID endpoint. Make sure your endpoint certificate is correct and if you need virtual hosted style requests then add the endpoint domain names in storageGRID 

image:ontap-migrate/sg-endpoint-domain.png[Set ONTAP group to read-only]

Your clients will either need to wait for the TTL to expire, or flush DNS to resolve to the new system so you can test that everything is working.  All that is left is to clean up the initial temporary S3 keys we used to test the StorageGRID data access (NOT the imported keys), remove the snapmirror relationships, and remove the ONTAP data. 


_By Rafael Guedes_
